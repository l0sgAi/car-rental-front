<template>
    <n-config-provider :theme="darkTheme">
        <div class="chat-container">
            <!-- Â∑¶‰æß‰ºöËØùÂàóË°® -->
            <n-layout-sider bordered content-style="padding: 0;" class="chat-sidebar" style="height: 100dvh;">
                <div class="sidebar-header">
                    <span class="sidebar-title">‰ºöËØùÂàóË°®</span>
                    <n-space :size="4">
                        <n-button quaternary circle @click="openSearchModal">
                            <template #icon>
                                <n-icon><search-outline /></n-icon>
                            </template>
                        </n-button>
                        <n-button quaternary circle @click="prepareNewConversation">
                            <template #icon>
                                <n-icon><add-outline /></n-icon>
                            </template>
                        </n-button>
                    </n-space>
                </div>

                <!-- ‰ºöËØùÂàóË°® -->
                <div class="conversation-list">
                    <template v-if="loading">
                        <div class="loading-container">
                            <n-spin size="small" />
                            <span>Âä†ËΩΩ‰∏≠...</span>
                        </div>
                    </template>

                    <template v-else-if="conversations.length > 0">
                        <div v-for="conv in conversations" :key="conv.id"
                            :class="['conversation-item', activeConversationId === conv.id ? 'active' : '']"
                            @click="switchConversation(conv.id)">
                            <n-space justify="space-between" align="left" style="width: 100%;">
                                <div
                                    style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; width: 100%;">
                                    <div class="conversation-title" :title="conv.originalTitle">
                                        <n-space align="left" :wrap="false" size="small"
                                            style="width: 100%; min-width: 0;">
                                            <n-icon style="flex-shrink: 0;"><chatbubble-outline /></n-icon>
                                            <n-icon v-if="conv.isFavorite" color="#f39c12" style="flex-shrink: 0;">
                                                <star />
                                            </n-icon>
                                            <span
                                                style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;">{{
                                                    conv.title }}</span>
                                        </n-space>
                                    </div>
                                    <div class="conversation-time">
                                        <n-time :time="conv.time" format="MM-dd HH:mm" />
                                    </div>
                                </div>

                                <n-space :size="0" :wrap="false">
                                    <n-popconfirm @positive-click="deleteConversation(conv.id)" positive-text="Á°ÆËÆ§"
                                        negative-text="ÂèñÊ∂à">
                                        <template #trigger>
                                            <n-button quaternary circle size="tiny" style="margin: 0;">
                                                <template #icon>
                                                    <n-icon size="12"><trash-outline /></n-icon>
                                                </template>
                                            </n-button>
                                        </template>
                                        Á°ÆÂÆöË¶ÅÂà†Èô§‰ºöËØù "{{ conv.originalTitle }}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ
                                    </n-popconfirm>
                                </n-space>
                            </n-space>
                        </div>
                    </template>
                    <n-empty :show-icon="false" v-else description="ÊöÇÊó†‰ºöËØù" />
                </div>
            </n-layout-sider>

            <!-- ‰∏ªËÅäÂ§©Âå∫Âüü -->
            <n-layout class="chat-main">
                <!-- ËÅäÂ§©Â§¥ÈÉ® -->
                <n-layout-header bordered class="chat-header">
                    <div class="chat-title">
                        {{activeConversationId ? conversations.find(conv => conv.id === activeConversationId)?.title ||
                            'AIËÅäÂ§©' :
                            'AIËÅäÂ§©'}}
                    </div>
                    <n-space align="center">
                        <n-button @click="goToConfig" class="header-btn-config" type="primary" secondary v-if="isAdmin">
                            <template #icon>
                                <n-icon><settings-outline /></n-icon>
                            </template>
                            ËÆæÁΩÆ
                        </n-button>
                        <n-button @click="logout" class="header-btn-out" type="error" secondary>
                            <template #icon>
                                <n-icon><log-out-outline /></n-icon>
                            </template>
                            ÈÄÄÂá∫ÁôªÂΩï
                        </n-button>
                    </n-space>
                </n-layout-header>

                <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
                <n-layout-content ref="chatContentRef" class="chat-messages" @click="handleImageClick">
                    <template v-if="messages.length > 0">
                        <div v-for="msg in messages" :key="msg.id"
                            :class="['message', msg.sender === username ? 'user-message' : 'ai-message']"
                            :data-message-id="msg.id">
                            <div class="message-bubble">
                                <div class="message-header">
                                    <span class="sender">{{ msg.sender }}</span>
                                    <span class="time">{{ msg.time }}</span>

                                </div>
                                <div class="message-content markdown-body" v-html="formatMessageContent(msg.content)">
                                </div>
                                <div v-if="msg.isStreaming && !msg.content" class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                        <div class="bottom-spacer-static"></div>
                    </template>
                    <n-empty :show-icon="false" class="empty-conversations" v-else description="üòäÊÇ®Â•ΩÔºåËØ∑ÈóÆÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÊÇ®ÁöÑÔºü" />
                </n-layout-content>

                <!-- Â∫ïÈÉ®ËæìÂÖ•Âå∫Âüü -->
                <n-layout-footer bordered class="chat-input-container">
                    <div class="chat-input-section">
                        <!-- ‰∏äÂçäÈÉ®ÂàÜÔºöËæìÂÖ•Ê°Ü -->
                        <div class="input-area">
                            <n-input v-model:value="newMessage" type="textarea" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
                                @keydown="handleKeyDown" class="chat-input" :autosize="{ minRows: 2, maxRows: 4 }"
                                :bordered="false" />
                        </div>

                        <!-- ÂõæÁâáÈ¢ÑËßàÂå∫ÂüüÔºà‰ªÖÂú®ËßÜËßâÊ®°Âûã‰∏îÊúâ‰∏ä‰º†ÂõæÁâáÊó∂ÊòæÁ§∫Ôºâ -->
                        <div v-if="isVisionModel && uploadedImages.length > 0" class="image-preview-area">
                            <n-space size="small">
                                <div v-for="image in uploadedImages" :key="image.id" class="uploaded-image-item">
                                    <div class="image-container">
                                        <n-image :src="image.url" :alt="image.name" width="200" height="200"
                                            object-fit="cover" />
                                        <n-button size="tiny" quaternary circle class="remove-image-btn"
                                            @click="removeImage(image.id)"
                                            style="background: rgba(0,0,0,0.5); color: white;">
                                            <template #icon>
                                                <n-icon size="10"><close-outline /></n-icon>
                                            </template>
                                        </n-button>
                                    </div>
                                    <span class="image-name">{{ image.name }}</span>
                                </div>
                            </n-space>
                        </div>

                        <!-- ‰∏ãÂçäÈÉ®ÂàÜÔºöÊìç‰ΩúÈÄâÈ°π -->
                        <div class="control-area">
                            <n-space justify="space-between" align="center" style="width: 100%;">
                                <!-- Â∑¶‰æßÔºöÊ®°ÂûãÈÄâÊã©ÂíåÂõæÁâá‰∏ä‰º† -->
                                <div class="model-selection">
                                    <n-space align="center" size="small">
                                        <span class="model-label">Ê®°Âûã:</span>
                                        <n-select v-model:value="selectedModelId" :options="modelOptions"
                                            placeholder="ÈÄâÊã©Ê®°Âûã" size="small" style="width: 180px;"
                                            :loading="modelsLoading" />
                                        <!-- ËßÜËßâÊ®°ÂûãÊó∂ÊòæÁ§∫ÂõæÁâá‰∏ä‰º†ÊåâÈíÆ -->
                                        <n-upload v-if="isVisionModel" :custom-request="handleImageUpload"
                                            accept="image/*" :show-file-list="false" multiple>
                                            <n-button ghost="true" size="small" type="primary" secondary
                                                :loading="isUploading">
                                                <template #icon>
                                                    <n-icon><image-outline /></n-icon>
                                                </template>
                                                ‰∏ä‰º†ÂõæÁâá
                                            </n-button>
                                        </n-upload>
                                    </n-space>
                                </div>

                                <!-- Âè≥‰æßÔºöÂèëÈÄÅÊåâÈíÆ -->
                                <div class="send-area">
                                    <n-space align="center" size="small">
                                        <span class="shortcut-hint">EnterÂèëÈÄÅ ‚Ä¢ Shift+EnterÊç¢Ë°å</span>
                                        <n-button type="primary"
                                            :disabled="(!isGenerating && !newMessage.trim()) || !selectedModelId"
                                            @click="isGenerating ? stopGeneration() : sendMessage()"
                                            class="send-button">
                                            <template #icon>
                                                <n-icon>
                                                    <send-outline v-if="!isGenerating" />
                                                    <stop-outline v-else />
                                                </n-icon>
                                            </template>
                                            {{ isGenerating ? 'ÂÅúÊ≠¢' : 'ÂèëÈÄÅ' }}
                                        </n-button>
                                    </n-space>
                                </div>
                            </n-space>
                        </div>
                    </div>
                </n-layout-footer>
            </n-layout>
        </div>
    </n-config-provider>

    <!-- Naive UI ÂõæÁâáÈ¢ÑËßà Modal -->
    <n-modal v-model:show="showImageModal" :bordered="false">
        <img :src="previewImageUrl" style="max-width: 80dvw; max-height: 80dvh; display: block;" />
    </n-modal>

    <!-- ÂÖ®Â±ÄÊêúÁ¥¢ Modal -->
    <n-config-provider :theme="darkTheme">
        <n-modal v-model:show="showSearchModal" preset="card" class="search-modal" title="ÂÖ®Â±ÄÊêúÁ¥¢"
            style="max-width: 60vw;">
            <div class="search-modal-content">
                <!-- ÊêúÁ¥¢ËæìÂÖ•Ê°Ü -->
                <div class="search-input-section">
                    <n-input v-model:value="searchKeyword" placeholder="ÊêúÁ¥¢Ê∂àÊÅØÂÜÖÂÆπ..." clearable @input="handleSearchInput"
                        @clear="clearSearch" size="medium" class="search-modal-input">
                        <template #prefix>
                            <n-icon><search-outline /></n-icon>
                        </template>
                    </n-input>
                </div>

                <!-- ÊêúÁ¥¢ÁªìÊûúÂå∫Âüü -->
                <div class="search-results-section">
                    <!-- ÊêúÁ¥¢ÁªìÊûúÂàóË°® -->
                    <div v-if="searchResults.length > 0" class="search-results">
                        <div class="search-results-header">
                            <span>ÊêúÁ¥¢ÁªìÊûú ({{ searchResults.length }})</span>
                        </div>
                        <div class="search-results-list">
                            <div v-for="result in searchResults" :key="result.id" class="search-result-item"
                                @click="jumpToMessage(result)">
                                <div class="search-result-content">
                                    <!-- Ê†πÊçÆÂåπÈÖç‰ºòÂÖàÁ∫ßÊòæÁ§∫ÂÜÖÂÆπ -->
                                    <template v-if="getMatchedContent(result).type === 'user'">
                                        <div class="search-result-user">
                                            <n-icon size="25" class="search-result-icon"><person-outline /></n-icon>
                                            <span class="search-result-text"
                                                v-html="highlightKeyword(getMatchedContent(result).content)"></span>
                                        </div>
                                    </template>
                                    <template v-else>
                                        <div class="search-result-ai">
                                            <n-icon size="25" class="search-result-icon"><chatbubble-outline /></n-icon>
                                            <span class="search-result-text"
                                                v-html="highlightKeyword(getMatchedContent(result).content)"></span>
                                        </div>
                                    </template>
                                </div>
                                <div class="search-result-time">
                                    <n-time :time="new Date(result.createTime)" format="MM-dd HH:mm" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Êó†ÊêúÁ¥¢ÁªìÊûúÊèêÁ§∫ -->
                    <div v-if="searchKeyword && searchResults.length === 0 && !searchLoading" class="no-search-results">
                        <n-empty description="Êó†ÊêúÁ¥¢ÁªìÊûú">
                            <template #icon>
                                <n-icon>
                                    <AlertCircleSharp />
                                </n-icon>
                            </template>
                        </n-empty>
                    </div>

                    <!-- ÊêúÁ¥¢Âä†ËΩΩÁä∂ÊÄÅ -->
                    <div v-if="searchLoading" class="search-loading">
                        <n-spin size="medium" />
                        <span>ÊêúÁ¥¢‰∏≠...</span>
                    </div>

                    <!-- ÂàùÂßãÁä∂ÊÄÅÊèêÁ§∫ -->
                    <div v-if="!searchKeyword && searchResults.length === 0 && !searchLoading"
                        class="search-placeholder">
                        <n-empty description="ËØ∑Âú®‰∏äÊñπËæìÂÖ•ÂÖ®ÊñáÊ£ÄÁ¥¢ÂÜÖÂÆπ">
                            <template #icon>
                                <n-icon>
                                    <FileTrayFullSharp />
                                </n-icon>
                            </template>
                        </n-empty>
                    </div>
                </div>
            </div>
        </n-modal>
    </n-config-provider>

</template>

<script setup>
import { userApi, chatApi, sessionApi, messageApi, configApi } from '../api';
import { ref, onMounted, nextTick, watch, computed } from 'vue';
import { useRouter } from 'vue-router';
import { useMessage, useDialog, darkTheme } from 'naive-ui';
import { h } from 'vue';
import {
    NConfigProvider,
    NLayout,
    NLayoutSider,
    NLayoutHeader,
    NLayoutContent,
    NLayoutFooter,
    NButton,
    NInput,
    NTime,
    NSpace,
    NIcon,
    NDropdown,
    NEmpty,
    NSpin,
    NPopconfirm,
    NSelect,
    NUpload,
    NUploadDragger,
    NImage,
    NTag,
    NModal
} from 'naive-ui';
import {
    ChatbubbleOutline,
    AddOutline,
    SendOutline,
    LogOutOutline,
    FileTrayFullSharp,
    TrashOutline,
    CreateOutline,
    AlertCircleSharp,
    Star,
    StopOutline,
    SettingsOutline,
    ImageOutline,
    CloseOutline,
    SearchOutline,
    PersonOutline
} from '@vicons/ionicons5';

import { Marked } from 'marked';
import hljs from 'highlight.js';
import { markedHighlight } from "marked-highlight";
import katex from 'katex';

// ÂºïÂÖ•Áã¨Á´ãÁöÑCSSÊñá‰ª∂
import '../assets/css/chat.css';
import 'github-markdown-css/github-markdown.css';
import 'highlight.js/styles/monokai-sublime.css';
import 'katex/dist/katex.min.css';

const router = useRouter();
const message = useMessage();
const dialog = useDialog();
const messages = ref([]);
const newMessage = ref('');
const username = ref('Áî®Êà∑');
const activeConversationId = ref(null);
const isAdmin = ref(false);

// ‰ºöËØùÂàóË°®Êï∞ÊçÆ
const conversations = ref([]);
const loading = ref(false);

// Ê®°ÂûãÈÄâÊã©Áõ∏ÂÖ≥
const selectedModelId = ref(null);
const modelOptions = ref([]);
const modelsLoading = ref(false);
const selectedModelData = ref(null);

// ÂõæÁâá‰∏ä‰º†Áõ∏ÂÖ≥
const uploadedImages = ref([]);
const isUploading = ref(false);

// AIÁîüÊàêÁä∂ÊÄÅÊéßÂà∂
const isGenerating = ref(false);
const currentEventSource = ref(null);
const currentStreamSessionId = ref(null);

// ÂõæÁâáÈ¢ÑËßàÁõ∏ÂÖ≥
const showImageModal = ref(false);
const previewImageUrl = ref('');

// ÂÖ®Â±ÄÊêúÁ¥¢Áõ∏ÂÖ≥
const searchKeyword = ref('');
const searchResults = ref([]);
const isSearching = ref(false);
const searchLoading = ref(false);
const showSearchModal = ref(false);
let searchTimeout = null;

const chatContentRef = ref(null);

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÂà§Êñ≠ÂΩìÂâçÈÄâÊã©ÁöÑÊ®°ÂûãÊòØÂê¶‰∏∫ËßÜËßâÊ®°Âûã
const isVisionModel = computed(() => {
    return selectedModelData.value && selectedModelData.value.modelType === 2;
});

// Êà™Êñ≠Ê†áÈ¢òÂà∞ÊúÄÈïø11‰∏™Â≠óÁ¨¶
const truncateTitle = (title) => {
    if (!title) return 'Êñ∞‰ºöËØù';
    return title.length > 10 ? title.substring(0, 10) + '...' : title;
};

// Êà™Êñ≠ÊëòË¶ÅÂà∞ÊúÄÈïø20‰∏™Â≠óÁ¨¶
const truncateSummary = (summary) => {
    if (!summary) return 'Êó†Ê∂àÊÅØ';
    return summary.length > 20 ? summary.substring(0, 20) + '...' : summary;
};

// Âä†ËΩΩ‰ºöËØùÂàóË°®
const loadConversations = async () => {
    try {
        loading.value = true;
        const response = await sessionApi.selectSessions();
        if (response.code === 200) {
            conversations.value = response.data.map(session => ({
                id: session.id,
                title: truncateTitle(session.title),
                lastMessage: truncateSummary(session.summary),
                time: new Date(session.lastMessageTime || session.createdTime),
                messages: [],
                originalTitle: session.title, // ‰øùÂ≠òÂéüÂßãÊ†áÈ¢òÁî®‰∫éÊòæÁ§∫ÂÆåÊï¥‰ø°ÊÅØ
                originalSummary: session.summary, // ‰øùÂ≠òÂéüÂßãÊëòË¶Å
                isFavorite: session.isFavorite,
                tags: session.tags
            }));
        } else {
            message.error(`Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•: ${response.message}`);
        }
    } catch (error) {
        message.error(`Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•: ${error.message}`);
    } finally {
        loading.value = false;
    }
};

// Âä†ËΩΩÊ®°ÂûãÂàóË°®
const loadModels = async () => {
    try {
        modelsLoading.value = true;
        const response = await configApi.getModels();
        if (response.code === 200) {
            const modelsData = response.data;
            modelOptions.value = modelsData.map(model => ({
                label: model.displayName,
                value: model.id
            }));

            // ËÆæÁΩÆÈªòËÆ§ÈÄâ‰∏≠ÁöÑÊ®°ÂûãÔºàisDefault‰∏∫1ÁöÑÊ®°ÂûãÔºâ
            const defaultModel = modelsData.find(model => model.isDefault === 1);
            if (defaultModel) {
                selectedModelId.value = defaultModel.id;
                selectedModelData.value = defaultModel;
            } else if (modelsData.length > 0) {
                // Â¶ÇÊûúÊ≤°ÊúâÈªòËÆ§Ê®°ÂûãÔºåÈÄâÊã©Á¨¨‰∏Ä‰∏™
                selectedModelId.value = modelsData[0].id;
                selectedModelData.value = modelsData[0];
            }

            // ÁõëÂê¨Ê®°ÂûãÈÄâÊã©ÂèòÂåñÔºåÊõ¥Êñ∞Ê®°ÂûãÊï∞ÊçÆ
            watch(selectedModelId, (newModelId) => {
                const selectedModel = modelsData.find(model => model.id === newModelId);
                selectedModelData.value = selectedModel || null;
                // ÂΩìÂàáÊç¢Ê®°ÂûãÊó∂ÔºåÊ∏ÖÁ©∫Â∑≤‰∏ä‰º†ÁöÑÂõæÁâá
                if (uploadedImages.value.length > 0) {
                    uploadedImages.value = [];
                }
            });
        } else {
            message.error(`Âä†ËΩΩÊ®°ÂûãÂàóË°®Â§±Ë¥•: ${response.message}`);
        }
    } catch (error) {
        message.error(`Âä†ËΩΩÊ®°ÂûãÂàóË°®Â§±Ë¥•: ${error.message}`);
    } finally {
        modelsLoading.value = false;
    }
};

// Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
const scrollToBottom = async () => {
    await nextTick(); // Á≠âÂæÖDOMÊõ¥Êñ∞ÂÆåÊàê
    const layoutInst = chatContentRef.value;
    if (layoutInst) {
        const scrollContainer = layoutInst.$el; // .n-layout-scroll-container
        if (scrollContainer) {
            // Êü•ÊâæÂÆûÈôÖÁöÑÊªöÂä®Â≠êÂÆπÂô®
            const actualScrollContainer = scrollContainer.querySelector('.n-scrollbar-container') ||
                scrollContainer.querySelector('.n-layout-scroll-container') ||
                scrollContainer.querySelector('[class*="scroll"]') ||
                scrollContainer.firstElementChild;
            // console.log('Actual scroll container:', actualScrollContainer);
            if (actualScrollContainer) {
                actualScrollContainer.scrollTo({
                    top: actualScrollContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }
    }
};

// ÁõëÂê¨Ê∂àÊÅØÂèòÂåñÔºåËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
watch(messages, () => {
    scrollToBottom();
}, { deep: true });

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Âä†ËΩΩ‰ºöËØùÂàóË°®
onMounted(async () => {
    // ÈÖçÁΩÆmarked‰ΩøÁî®highlight.jsËøõË°å‰ª£Á†ÅÈ´ò‰∫Æ
    loadConversations();
    loadModels(); // Âä†ËΩΩÊ®°ÂûãÂàóË°®

    // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºåÊ£ÄÊü•ÊòØÂê¶‰∏∫ÁÆ°ÁêÜÂëò
    try {
        const response = await userApi.getUserInfo();
        if (response.code === 200) {
            username.value = response.data.username || 'Áî®Êà∑';
            isAdmin.value = response.data.role === 1; // role=1‰∏∫ÁÆ°ÁêÜÂëò
        }
    } catch (error) {
        console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
    }
});

// ÂàáÊç¢‰ºöËØù
const switchConversation = async (convId) => {
    // ‰øùÂ≠òÂΩìÂâç‰ºöËØùÁöÑÊ∂àÊÅØ
    const currentConv = conversations.value.find(conv => conv.id === activeConversationId.value);
    if (currentConv) {
        currentConv.messages = [...messages.value];
    }

    // ÂàáÊç¢Âà∞Êñ∞‰ºöËØù
    activeConversationId.value = convId;

    // ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩ‰ºöËØùÁöÑÂéÜÂè≤Ê∂àÊÅØ
    try {
        // console.log('Ê≠£Âú®Âä†ËΩΩ‰ºöËØùÂéÜÂè≤Ê∂àÊÅØÔºå‰ºöËØùID:', convId);
        const response = await messageApi.getMessagesBySessionId(convId);
        // console.log('ÂéÜÂè≤Ê∂àÊÅØAPIÂìçÂ∫î:', response);

        if (response.code === 200) {
            // console.log('ÂéÜÂè≤Ê∂àÊÅØÊï∞ÊçÆ:', response.data);

            // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶‰∏∫Á©∫
            if (!response.data || response.data.length === 0) {
                console.log('ËØ•‰ºöËØùÊöÇÊó†ÂéÜÂè≤Ê∂àÊÅØ');
                messages.value = [];
                return;
            }

            // ÂÖàÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÊ∂àÊÅØÂØπ
            const sortedData = response.data.sort((a, b) => new Date(a.createTime) - new Date(b.createTime));

            // Â∞ÜÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊ∂àÊÅØËΩ¨Êç¢‰∏∫ÂâçÁ´ØÊ∂àÊÅØÊ†ºÂºè
            const historyMessages = sortedData.map(msgPair => {
                const pairMessages = [];

                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
                if (msgPair.userContent) {
                    pairMessages.push({
                        id: `user-${msgPair.id}`, // ‰ΩøÁî®ÂèØÈ¢ÑÊµãÁöÑÂîØ‰∏ÄID
                        sender: username.value,
                        content: msgPair.userContent,
                        time: new Date(msgPair.createTime).toLocaleTimeString(),
                        createTime: msgPair.createTime
                    });
                }

                // Ê∑ªÂä†AIÂõûÂ§çÊ∂àÊÅØ
                if (msgPair.aiContent) {
                    pairMessages.push({
                        id: `ai-${msgPair.id}`, // ‰ΩøÁî®ÂèØÈ¢ÑÊµãÁöÑÂîØ‰∏ÄID
                        sender: 'AIÂä©Êâã',
                        content: msgPair.aiContent,
                        time: msgPair.responseTime ? new Date(msgPair.responseTime).toLocaleTimeString() : new Date(msgPair.createTime).toLocaleTimeString(),
                        createTime: msgPair.responseTime || msgPair.createTime
                    });
                }

                return pairMessages;
            }).flat();

            // console.log('ËΩ¨Êç¢ÂêéÁöÑÂéÜÂè≤Ê∂àÊÅØ:', historyMessages);
            messages.value = historyMessages;
        } else {
            console.error('Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØÂ§±Ë¥•:', response.message);
            messages.value = [];
        }
    } catch (error) {
        console.error('Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØÂ§±Ë¥•:', error);
        messages.value = [];
    }
};

// ÂáÜÂ§áÊñ∞‰ºöËØùÁä∂ÊÄÅÔºà‰∏çÁ´ãÂç≥ÂàõÂª∫Ôºâ
const prepareNewConversation = () => {
    // ÂèñÊ∂àÂΩìÂâçÈÄâ‰∏≠ÁöÑ‰ºöËØù
    activeConversationId.value = null;
    // Ê∏ÖÁ©∫Ê∂àÊÅØÂàóË°®
    messages.value = [];
};

// ÂàõÂª∫Êñ∞‰ºöËØùÔºàÂÆûÈôÖÂàõÂª∫Ôºâ
const createNewConversation = async (firstQuestion = null) => {
    try {
        loading.value = true;
        const sessionData = {
            title: firstQuestion ? truncateTitle(firstQuestion) : `Êñ∞‰ºöËØù ${conversations.value.length + 1}`,
            isFavorite: 0,
            modelId: selectedModelId.value || 1, // ‰ΩøÁî®ÈÄâ‰∏≠ÁöÑÊ®°ÂûãIDÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ΩøÁî®ÈªòËÆ§ÂÄº1
            tags: '',
            summary: ''
        };

        const response = await sessionApi.addSession(sessionData);
        if (response.code === 200) {
            const newId = response.data; // ÂêéÁ´ØËøîÂõûÊèíÂÖ•ÁöÑid
            const newConversation = {
                id: newId,
                title: sessionData.title,
                lastMessage: '',
                time: new Date(),
                messages: [],
                originalTitle: firstQuestion || sessionData.title,
                originalSummary: '',
                isFavorite: 0,
                tags: ''
            };

            conversations.value.unshift(newConversation);
            activeConversationId.value = newId;
            message.success('Â∑≤ÂàõÂª∫Êñ∞‰ºöËØù');
            return newId;
        } else {
            message.error(`ÂàõÂª∫‰ºöËØùÂ§±Ë¥•: ${response.message}`);
            return null;
        }
    } catch (error) {
        message.error(`ÂàõÂª∫‰ºöËØùÂ§±Ë¥•: ${error.message}`);
        return null;
    } finally {
        loading.value = false;
    }
};

// ‰ºöËØùÊìç‰ΩúËèúÂçï
const conversationOptions = [
    {
        label: 'ÈáçÂëΩÂêç',
        key: 'rename',
        icon: () => h(NIcon, null, { default: () => h(CreateOutline) })
    }
];

// Âà†Èô§‰ºöËØù
const deleteConversation = async (convId) => {
    try {
        loading.value = true;

        // Âà†Èô§‰ºöËØù
        const response = await sessionApi.deleteSession(convId);
        if (response.code === 200) {
            conversations.value = conversations.value.filter(conv => conv.id !== convId);
            if (activeConversationId.value === convId) {
                if (conversations.value.length > 0) {
                    switchConversation(conversations.value[0].id);
                } else {
                    activeConversationId.value = null;
                    messages.value = [];
                }
            }
            message.success('‰ºöËØùÂèäÁõ∏ÂÖ≥Ê∂àÊÅØÂ∑≤Âà†Èô§');
        } else {
            message.error(`Âà†Èô§‰ºöËØùÂ§±Ë¥•: ${response.message}`);
        }
    } catch (error) {
        message.error(`Âà†Èô§‰ºöËØùÂ§±Ë¥•: ${error.message}`);
    } finally {
        loading.value = false;
    }
};

// Â§ÑÁêÜ‰ºöËØùËèúÂçïÈÄâÊã©
const handleConversationAction = (key, convId) => {
    if (key === 'rename') {
        // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞ÈáçÂëΩÂêçÂäüËÉΩ
        message.info('ÈáçÂëΩÂêçÂäüËÉΩÂæÖÂÆûÁé∞');
    }
};

// Â§ÑÁêÜÈîÆÁõò‰∫ã‰ª∂
const handleKeyDown = (event) => {
    // Â¶ÇÊûúÊåâ‰∏ãÁöÑÊòØEnterÈîÆ
    if (event.key === 'Enter') {
        // Â¶ÇÊûúÂêåÊó∂Êåâ‰∏ã‰∫ÜShiftÈîÆÔºåÂÖÅËÆ∏Êç¢Ë°åÔºà‰∏çÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫Ôºâ
        if (event.shiftKey) {
            return; // ÂÖÅËÆ∏ÈªòËÆ§ÁöÑÊç¢Ë°åË°å‰∏∫
        }
        // Â¶ÇÊûúÂè™Êåâ‰∏ãEnterÈîÆÔºåÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫Âπ∂ÂèëÈÄÅÊ∂àÊÅØ
        event.preventDefault();
        if (!isGenerating.value && newMessage.value.trim() && selectedModelId.value) {
            sendMessage();
        }
    }
};

// ÂõæÁâá‰∏ä‰º†Â§ÑÁêÜ
const handleImageUpload = async ({ file, onFinish, onError }) => {
    try {
        isUploading.value = true;

        // ÂàõÂª∫FormData
        const formData = new FormData();
        formData.append('file', file.file);

        // Ë∞ÉÁî®‰∏ä‰º†API
        const response = await fetch('/api/system/file/fileUpload', {
            method: 'POST',
            body: formData,
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        const result = await response.json();

        if (result.code === 200) {
            // Âè™Ê∑ªÂä†ÂΩìÂâç‰∏ä‰º†ÁöÑÂõæÁâáÂà∞ÂàóË°®
            const newImage = {
                id: Date.now() + Math.random(),
                url: result.data,
                name: file.name,
                size: file.size, // Ê∑ªÂä†Êñá‰ª∂Â§ßÂ∞èÁî®‰∫éÂéªÈáç
                status: 'success'
            };
            uploadedImages.value.push(newImage);
            message.success('ÂõæÁâá‰∏ä‰º†ÊàêÂäü');
            onFinish && onFinish();
        } else {
            message.error(`ÂõæÁâá‰∏ä‰º†Â§±Ë¥•: ${result.message}`);
            onError && onError();
        }
    } catch (error) {
        console.error('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•:', error);
        message.error('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•');
        onError && onError();
    } finally {
        isUploading.value = false;
    }
};

// ÁßªÈô§Â∑≤‰∏ä‰º†ÁöÑÂõæÁâá
const removeImage = (imageId) => {
    uploadedImages.value = uploadedImages.value.filter(img => img.id !== imageId);
};

const sendMessage = async () => {
    if (!newMessage.value.trim()) return;

    // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÈÄâÊã©Ê®°Âûã
    if (!selectedModelId.value) {
        message.error('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ê®°Âûã');
        return;
    }

    try {
        // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©‰ºöËØùÔºåÂÖàÂàõÂª∫Êñ∞‰ºöËØù
        if (!activeConversationId.value) {
            const newSessionId = await createNewConversation(newMessage.value.trim());
            // Á≠âÂæÖ‰ºöËØùÂàõÂª∫ÂÆåÊàêÂêéÂÜçÂèëÈÄÅÊ∂àÊÅØ
            if (!newSessionId) {
                message.error('ÂàõÂª∫‰ºöËØùÂ§±Ë¥•ÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ');
                return;
            }
        }

        // Á´ãÂç≥Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
        const messageContent = newMessage.value.trim();
        newMessage.value = '';

        // ÊûÑÈÄ†ÂõæÁâá HTMLÔºàÂ¶ÇÊûú‰ΩøÁî®ËßÜËßâÊ®°Âûã‰∏îÊúâÂõæÁâáÔºâ
        let imageHtml = '';
        if (uploadedImages.value.length > 0) {
            imageHtml = uploadedImages.value.map(img =>
                `<div style="margin-bottom: 8px;">
                        <img src="${img.url}" alt="${img.name}" 
                        class="chat-image-preview" 
                        style="max-width: 30%; 
                        border-radius: 8px;" />
                    </div>`
            ).join('');
        }
        // ÊûÑÈÄ†ÂÆåÊï¥Ê∂àÊÅØÂÜÖÂÆπ
        const fullContent = imageHtml + (messageContent ? `<p>${messageContent}</p>` : '');

        // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÂΩìÂâç‰ºöËØù
        const userMsg = {
            id: `local-user-${Date.now()}`,
            sender: username.value,
            content: fullContent,
            time: new Date().toLocaleTimeString()
        };
        messages.value.push(userMsg);

        // Êõ¥Êñ∞ÂΩìÂâç‰ºöËØùÁöÑÊúÄÂêéÊ∂àÊÅØÂíåÊó∂Èó¥
        const currentConv = conversations.value.find(conv => conv.id === activeConversationId.value);
        if (currentConv) {
            currentConv.lastMessage = userMsg.content;
            currentConv.time = new Date();
            currentConv.messages = [...messages.value];
        }

        // ÂáÜÂ§áÂèëÈÄÅÁöÑÊï∞ÊçÆ
        const sendData = {
            question: fullContent,
            sessionId: activeConversationId.value,
            modelId: selectedModelId.value, // ‰ΩøÁî®ÈÄâ‰∏≠ÁöÑÊ®°ÂûãID
            conversationId: activeConversationId.value
        };

        // Â¶ÇÊûúÊòØËßÜËßâÊ®°Âûã‰∏îÊúâ‰∏ä‰º†ÁöÑÂõæÁâáÔºåÊ∑ªÂä†ÂõæÁâáURLÂàóË°®
        if (isVisionModel.value && uploadedImages.value.length > 0) {
            sendData.urlList = uploadedImages.value.map(img => img.url);
        }

        // ÂèëÈÄÅÊ∂àÊÅØÂà∞ÂêéÁ´ØËé∑ÂèñsessionId
        const response = await chatApi.sendMessage(sendData);

        // console.log('ÂèëÈÄÅÊ∂àÊÅØAPIÂìçÂ∫î:', response); // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó

        // ÂÖàÊ∏ÖÁ©∫ÁõÆÂâçÁöÑ‰∏ä‰º†ÂàóË°®
        uploadedImages.value = [];

        if (response.code === 200) {
            const streamSessionId = response.data; // ÂêéÁ´ØËøîÂõûÁöÑsessionId

            // ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂà∞Êï∞ÊçÆÂ∫ì
            let messagePairId = null;
            try {
                const messageData = {
                    sessionId: activeConversationId.value,
                    sseSessionId: streamSessionId, // ‰ΩøÁî®Ëé∑ÂèñÂà∞ÁöÑSSE‰ºöËØùID
                    userContent: fullContent,
                    aiContent: '', // AIÂõûÂ§çÂÜÖÂÆπÊöÇÊó∂‰∏∫Á©∫
                    modelUsed: selectedModelId.value, // ÈªòËÆ§Ê®°ÂûãID
                    status: 0, // 0-ÁîüÊàê‰∏≠
                    tokens: 0, // ÊöÇÊó∂‰∏∫0
                    createTime: new Date(),
                    responseTime: null
                };

                const saveResponse = await messageApi.addMessage(messageData);
                if (saveResponse.code === 200) {
                    messagePairId = saveResponse.data; // ‰øùÂ≠òÊ∂àÊÅØÂØπID
                    console.log('Áî®Êà∑Ê∂àÊÅØÂ∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÊ∂àÊÅØÂØπID:', messagePairId);
                } else {
                    console.error('‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂ§±Ë¥•:', saveResponse.message);
                }
            } catch (error) {
                console.error('‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂ§±Ë¥•:', error);
            }

            // ÂàõÂª∫AIÊ∂àÊÅØÂç†‰ΩçÁ¨¶
            const aiMsg = {
                id: `local-ai-${Date.now()}`,
                sender: 'AIÂä©Êâã',
                content: '',
                time: new Date().toLocaleTimeString(),
                isStreaming: true,
                messagePairId: messagePairId // ÂÖ≥ËÅîÊ∂àÊÅØÂØπID
            };
            messages.value.push(aiMsg);

            // ËÆæÁΩÆÁîüÊàêÁä∂ÊÄÅ
            isGenerating.value = true;
            currentStreamSessionId.value = streamSessionId;

            // Âª∫Á´ãSSEËøûÊé•Ëé∑ÂèñÊµÅÂºèÂìçÂ∫î
            console.log('ÂáÜÂ§áÂª∫Á´ãSSEËøûÊé•...'); // Ë∞ÉËØïÊó•Âøó
            const eventSource = chatApi.createSSEConnection(streamSessionId);
            currentEventSource.value = eventSource;

            eventSource.onmessage = (event) => {
                try {
                    // console.log('Êé•Êî∂Âà∞SSEÊï∞ÊçÆ:', event.data); // Ë∞ÉËØïÊó•Âøó
                    // ÂêéÁ´ØÁõ¥Êé•ÂèëÈÄÅÊñáÊú¨ÂÜÖÂÆπÔºå‰∏çÊòØJSONÊ†ºÂºè
                    const text = event.data;
                    if (text && text.trim()) {
                        // console.log('Â§ÑÁêÜÊñáÊú¨ÂÜÖÂÆπ:', text); // Ë∞ÉËØïÊó•Âøó
                        // Á°Æ‰øùaiMsg.contentÊòØÂ≠óÁ¨¶‰∏≤Á±ªÂûãÔºåÁÑ∂ÂêéÁ¥ØÂä†ÂÜÖÂÆπ
                        aiMsg.content = (aiMsg.content || '') + text;
                        // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
                        messages.value = [...messages.value];
                        // ÊØèÊ¨°Êé•Êî∂Âà∞Êñ∞ÂÜÖÂÆπÊó∂ÊªöÂä®Âà∞Â∫ïÈÉ®
                        scrollToBottom();
                    }
                } catch (error) {
                    console.error('Â§ÑÁêÜSSEÊï∞ÊçÆÂ§±Ë¥•:', error, event);
                }
            };

            eventSource.onerror = (error) => {
                console.error('SSEËøûÊé•ÈîôËØØ:', error);
                aiMsg.isStreaming = false;
                isGenerating.value = false;
                currentEventSource.value = null;
                currentStreamSessionId.value = null;
                eventSource.close();

                // Â¶ÇÊûúÊ≤°ÊúâÊé•Êî∂Âà∞‰ªª‰ΩïÂÜÖÂÆπÔºåÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                if (!aiMsg.content) {
                    aiMsg.content = 'Êä±Ê≠âÔºåÊé•Êî∂Ê∂àÊÅØÊó∂Âá∫Áé∞ÈîôËØØÔºåËØ∑ÈáçËØï„ÄÇ';
                }
                // message.error('Êé•Êî∂Ê∂àÊÅØÊµÅÂ§±Ë¥•');
            };

            // ÁõëÂê¨ËøûÊé•ÊâìÂºÄ‰∫ã‰ª∂
            eventSource.onopen = () => {
                console.log('SSEËøûÊé•Â∑≤Âª∫Á´ã');
            };

            // ÁõëÂê¨ÊµÅÁªìÊùü‰∫ã‰ª∂
            eventSource.addEventListener('close', () => {
                console.log('SSEÊµÅÂ∑≤ÁªìÊùü');
                aiMsg.isStreaming = false;
                isGenerating.value = false;
                currentEventSource.value = null;
                currentStreamSessionId.value = null;
                eventSource.close();

                // Êõ¥Êñ∞‰ºöËØùÂàóË°®‰∏≠ÁöÑÊúÄÂêéÊ∂àÊÅØ
                if (currentConv && aiMsg.content) {
                    currentConv.lastMessage = aiMsg.content.substring(0, 20) + (aiMsg.content.length > 20 ? '...' : '');
                    currentConv.time = new Date();
                    currentConv.messages = [...messages.value];
                }

                console.log('AIÂõûÂ§çÂÆåÊàêÔºåÂêéÁ´Ø‰ºöËá™Âä®Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑAIÂõûÂ§çÂÜÖÂÆπ');
            });

            // ËÆæÁΩÆË∂ÖÊó∂Â§ÑÁêÜ
            setTimeout(() => {
                if (aiMsg.isStreaming && !aiMsg.content) {
                    console.warn('SSEËøûÊé•Ë∂ÖÊó∂ÔºåÊú™Êé•Êî∂Âà∞Êï∞ÊçÆ');
                    aiMsg.isStreaming = false;
                    isGenerating.value = false;
                    currentEventSource.value = null;
                    currentStreamSessionId.value = null;
                    aiMsg.content = 'ËøûÊé•Ë∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÈáçËØï„ÄÇ';
                    eventSource.close();
                    message.warning('ËøûÊé•Ë∂ÖÊó∂ÔºåËØ∑ÈáçËØï');
                }
            }, 30000); // 30ÁßíË∂ÖÊó∂

        } else {
            message.error(`ÂèëÈÄÅÂ§±Ë¥•: ${response.message}`);
            isGenerating.value = false;
            currentStreamSessionId.value = null;
        }
    } catch (error) {
        message.error(`ÂèëÈÄÅÂ§±Ë¥•: ${error.message}`);
        isGenerating.value = false;
        currentStreamSessionId.value = null;
    }

    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
    newMessage.value = '';
};

// ÂÅúÊ≠¢AIÁîüÊàê
const stopGeneration = async () => {
    if (!currentStreamSessionId.value) {
        console.warn('Ê≤°ÊúâÊâæÂà∞ÂΩìÂâçÁöÑSSE‰ºöËØùID');
        return;
    }

    try {
        // Ë∞ÉÁî®ÂêéÁ´ØÂÅúÊ≠¢Êé•Âè£
        const response = await chatApi.stopGeneration(currentStreamSessionId.value);
        if (response.code === 200) {
            console.log('ÂÅúÊ≠¢ÁîüÊàêÊàêÂäü:', response.message);
        } else {
            console.error('ÂÅúÊ≠¢ÁîüÊàêÂ§±Ë¥•:', response.message);
            message.error(`ÂÅúÊ≠¢ÁîüÊàêÂ§±Ë¥•: ${response.message}`);
        }
    } catch (error) {
        console.error('Ë∞ÉÁî®ÂÅúÊ≠¢Êé•Âè£Â§±Ë¥•:', error);
        message.error(`ÂÅúÊ≠¢ÁîüÊàêÂ§±Ë¥•: ${error.message}`);
    }

    // ÂÖ≥Èó≠ÂâçÁ´ØSSEËøûÊé•
    if (currentEventSource.value) {
        currentEventSource.value.close();
        currentEventSource.value = null;
    }

    // ÊâæÂà∞Ê≠£Âú®ÁîüÊàêÁöÑAIÊ∂àÊÅØÂπ∂ÂÅúÊ≠¢ÊµÅÂºèÁä∂ÊÄÅ
    const lastMessage = messages.value[messages.value.length - 1];
    if (lastMessage && lastMessage.sender === 'AIÂä©Êâã' && lastMessage.isStreaming) {
        lastMessage.isStreaming = false;
        if (!lastMessage.content) {
            lastMessage.content = 'ÁîüÊàêÂ∑≤ÂÅúÊ≠¢„ÄÇ';
        }
    }

    // ÈáçÁΩÆÁä∂ÊÄÅ
    isGenerating.value = false;
    currentStreamSessionId.value = null;
    message.info('Â∑≤ÂÅúÊ≠¢ÁîüÊàê');
};



// Ê∏≤ÊüìÊï∞Â≠¶ÂÖ¨ÂºèÁöÑËæÖÂä©ÂáΩÊï∞
const renderMath = (text) => {
    // ÂÖàÂ§ÑÁêÜÂùóÁ∫ßÂÖ¨Âºè $$...$$
    text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, formula) => {
        try {
            const rendered = katex.renderToString(formula.trim(), {
                displayMode: true,
                throwOnError: false,
                strict: false
            });
            return `<div class="math-block">${rendered}</div>`;
        } catch (error) {
            console.warn('ÂùóÁ∫ßÊï∞Â≠¶ÂÖ¨ÂºèÊ∏≤ÊüìÂ§±Ë¥•:', error, formula);
            return `<div class="math-error">$$${formula}$$</div>`;
        }
    });

    // ÂÜçÂ§ÑÁêÜË°åÂÜÖÂÖ¨Âºè $...$ÔºàÈÅøÂÖç‰∏éÂ∑≤Â§ÑÁêÜÁöÑÂùóÁ∫ßÂÖ¨ÂºèÂÜ≤Á™ÅÔºâ
    text = text.replace(/(?<!\$)\$(?!\$)([^$\n]+?)\$(?!\$)/g, (match, formula) => {
        try {
            const rendered = katex.renderToString(formula.trim(), {
                displayMode: false,
                throwOnError: false,
                strict: false
            });
            return `<span class="math-inline">${rendered}</span>`;
        } catch (error) {
            console.warn('Ë°åÂÜÖÊï∞Â≠¶ÂÖ¨ÂºèÊ∏≤ÊüìÂ§±Ë¥•:', error, formula);
            return `<span class="math-error">$${formula}$</span>`;
        }
    });

    return text;
};

// Ê†ºÂºèÂåñÊ∂àÊÅØÂÜÖÂÆπ
const formatMessageContent = (content) => {
    if (!content) return '';

    // ËØ¶ÁªÜÁöÑÁ±ªÂûãÊ£ÄÊü•ÂíåË∞ÉËØï‰ø°ÊÅØ
    // console.log('formatMessageContent ËæìÂÖ•Á±ªÂûã:', typeof content, 'ÂÄº:', content);

    // Á°Æ‰øùcontentÊòØÂ≠óÁ¨¶‰∏≤Á±ªÂûã
    let contentStr;
    try {
        contentStr = typeof content === 'string' ? content : String(content);
    } catch (stringifyError) {
        console.error('Â≠óÁ¨¶‰∏≤ËΩ¨Êç¢Â§±Ë¥•:', stringifyError);
        return '';
    }

    try {
        // Â§ÑÁêÜÂêéÁ´ØËøîÂõûÁöÑHTMLËΩ¨‰πâÂ≠óÁ¨¶ÔºåËΩ¨Êç¢‰∏∫MarkdownÂèØËØÜÂà´ÁöÑÊ†ºÂºè
        let processedContent = contentStr
            // ÂÖàÂ§ÑÁêÜÊç¢Ë°åÁ¨¶ÔºöÂ∞Ü<br>ËΩ¨Êç¢‰∏∫ÁúüÊ≠£ÁöÑÊç¢Ë°åÁ¨¶
            .replace(/<br\s*\/?>/gi, '\n')
            // Â§ÑÁêÜÈùûÊñ≠Ë°åÁ©∫Ê†ºÔºöÂú®‰ª£Á†ÅÂùó‰∏≠‰øùÁïôÔºåÂú®ÊôÆÈÄöÊñáÊú¨‰∏≠ËΩ¨Êç¢‰∏∫ÊôÆÈÄöÁ©∫Ê†º
            .replace(/&nbsp;/g, ' ')
            // Â§ÑÁêÜÂÖ∂‰ªñHTMLËΩ¨‰πâÂ≠óÁ¨¶
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&')
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'");

        // ÂÖàÊ∏≤ÊüìÊï∞Â≠¶ÂÖ¨ÂºèÔºàÂú®MarkdownËß£Êûê‰πãÂâçÔºâ
        processedContent = renderMath(processedContent);

        // ‰ΩøÁî®markedËß£ÊûêMarkdown
        // console.log('Ê†ºÂºèÂåñÊ∂àÊÅØÂÜÖÂÆπ:', processedContent);
        const marked = new Marked(
            markedHighlight({
                emptyLangClass: 'hljs',
                langPrefix: 'hljs language-',
                highlight(code, lang, info) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                }
            })
        );
        const html = marked.parse(processedContent);

        return html;
    } catch (error) {
        console.error('MarkdownËß£ÊûêÂ§±Ë¥•:', error, 'ËæìÂÖ•ÂÜÖÂÆπ:', contentStr);
        // ÈôçÁ∫ßÂà∞ÁÆÄÂçïÁöÑÊñáÊú¨ÊõøÊç¢
        try {
            const fallbackStr = typeof content === 'string' ? content : String(content);
            let fallbackContent = fallbackStr
                .replace(/<br\s*\/?>/gi, '<br>')
                .replace(/&nbsp;/g, ' ')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>');

            // Âç≥‰ΩøÂú®ÈôçÁ∫ßÊ®°Âºè‰∏ã‰πüÂ∞ùËØïÊ∏≤ÊüìÊï∞Â≠¶ÂÖ¨Âºè
            fallbackContent = renderMath(fallbackContent);
            return fallbackContent;
        } catch (fallbackError) {
            console.error('ÈôçÁ∫ßÂ§ÑÁêÜ‰πüÂ§±Ë¥•:', fallbackError);
            return String(content || '');
        }
    }
};

// Â§ÑÁêÜÂõæÁâáÁÇπÂáª‰∫ã‰ª∂
const handleImageClick = (event) => {
    // Ê£ÄÊü•ÁÇπÂáªÁöÑÂÖÉÁ¥†ÊòØÂê¶ÊòØÂõæÁâá
    if (event.target.tagName === 'IMG' && event.target.classList.contains('chat-image-preview')) {
        previewImageUrl.value = event.target.src;
        showImageModal.value = true;
    }
};

// ÂÖ®Â±ÄÊêúÁ¥¢Áõ∏ÂÖ≥ÊñπÊ≥ï
const openSearchModal = () => {
    showSearchModal.value = true;
    // Ê∏ÖÁ©∫‰πãÂâçÁöÑÊêúÁ¥¢Áä∂ÊÄÅ
    searchKeyword.value = '';
    searchResults.value = [];
    isSearching.value = false;
    searchLoading.value = false;
};

const handleSearchInput = () => {
    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }

    // Â¶ÇÊûúÊêúÁ¥¢ÂÖ≥ÈîÆËØç‰∏∫Á©∫ÔºåÊ∏ÖÁ©∫ÊêúÁ¥¢ÁªìÊûú
    if (!searchKeyword.value.trim()) {
        searchResults.value = [];
        searchLoading.value = false;
        return;
    }

    // ËÆæÁΩÆÈò≤ÊäñÔºå500msÂêéÊâßË°åÊêúÁ¥¢
    searchTimeout = setTimeout(() => {
        performGlobalSearch();
    }, 500);
};

const performGlobalSearch = async () => {
    if (!searchKeyword.value.trim()) {
        return;
    }

    try {
        searchLoading.value = true;
        isSearching.value = true;

        const response = await messageApi.globalQuery(searchKeyword.value.trim());

        if (response.code === 200) {
            searchResults.value = response.data || [];
        } else {
            message.error(`ÊêúÁ¥¢Â§±Ë¥•: ${response.message}`);
            searchResults.value = [];
        }
    } catch (error) {
        message.error(`ÊêúÁ¥¢Â§±Ë¥•: ${error.message}`);
        searchResults.value = [];
    } finally {
        searchLoading.value = false;
    }
};

const clearSearch = () => {
    searchKeyword.value = '';
    searchResults.value = [];
    isSearching.value = false;
    searchLoading.value = false;
    showSearchModal.value = false;

    if (searchTimeout) {
        clearTimeout(searchTimeout);
        searchTimeout = null;
    }
};

// Ëé∑ÂèñÂåπÈÖçÂÜÖÂÆπÁöÑ‰ºòÂÖàÁ∫ßÂíåÁ±ªÂûã
const getMatchedContent = (result) => {
    if (!searchKeyword.value.trim()) {
        return { type: 'user', content: result.userContent };
    }

    const keyword = searchKeyword.value.trim().toLowerCase();
    const userContent = result.userContent || '';
    const aiContent = result.aiContent || '';

    const userMatches = userContent.toLowerCase().includes(keyword);
    const aiMatches = aiContent.toLowerCase().includes(keyword);

    // Â¶ÇÊûúÁî®Êà∑ÂÜÖÂÆπÂåπÈÖçÔºåÊòæÁ§∫Áî®Êà∑ÂÜÖÂÆπÔºàÂç≥‰ΩøAIÂÜÖÂÆπ‰πüÂåπÈÖçÔºâ
    if (userMatches) {
        return {
            type: 'user',
            content: userContent
        };
    }

    // Â¶ÇÊûúÂè™ÊúâAIÂÜÖÂÆπÂåπÈÖç
    if (aiMatches) {
        return {
            type: 'ai',
            content: aiContent
        };
    }

    // Â¶ÇÊûúÈÉΩ‰∏çÂåπÈÖçÔºåÈªòËÆ§ÊòæÁ§∫Áî®Êà∑ÂÜÖÂÆπ
    return {
        type: 'user',
        content: '......' + userContent
    };
};

const highlightKeyword = (text) => {
    if (!text || !searchKeyword.value.trim()) {
        return text;
    }

    const keyword = searchKeyword.value.trim();
    const regex = new RegExp(`(${keyword})`, 'gi');

    // ÈôêÂà∂ÊòæÁ§∫ÈïøÂ∫¶ÔºåÈÅøÂÖçËøáÈïøÁöÑÊñáÊú¨
    let displayText = text;
    if (text.length > 100) {
        const keywordIndex = text.toLowerCase().indexOf(keyword.toLowerCase());
        if (keywordIndex !== -1) {
            const start = Math.max(0, keywordIndex - 30);
            const end = Math.min(text.length, keywordIndex + keyword.length + 30);
            displayText = (start > 0 ? '...' : '') + text.substring(start, end) + (end < text.length ? '...' : '');
        } else {
            displayText = text.substring(0, 100) + '...';
        }
    }

    return displayText.replace(regex, '<mark>$1</mark>');
};

const jumpToMessage = async (result) => {
    try {
        // ÂÖ≥Èó≠ÊêúÁ¥¢Modal
        showSearchModal.value = false;

        // Â¶ÇÊûúÂΩìÂâç‰∏çÂú®ÂØπÂ∫îÁöÑ‰ºöËØù‰∏≠ÔºåÂÖàÂàáÊç¢Âà∞ÂØπÂ∫î‰ºöËØù
        if (activeConversationId.value !== result.sessionId) {
            await switchConversation(result.sessionId);
        }

        // Ê∏ÖÁ©∫ÊêúÁ¥¢Áä∂ÊÄÅ
        searchKeyword.value = '';
        searchResults.value = [];
        isSearching.value = false;
        searchLoading.value = false;
        if (searchTimeout) {
            clearTimeout(searchTimeout);
            searchTimeout = null;
        }

        // Á≠âÂæÖDOMÊõ¥Êñ∞ÂêéÊªöÂä®Âà∞ÂØπÂ∫îÊ∂àÊÅØ
        await nextTick();

        // Êü•ÊâæÂØπÂ∫îÁöÑÁî®Êà∑ÂíåAIÊ∂àÊÅØÂÖÉÁ¥†
        const userMessageId = `user-${result.id}`;
        const aiMessageId = `ai-${result.id}`;

        const userElement = document.querySelector(`[data-message-id='${userMessageId}']`);
        const aiElement = document.querySelector(`[data-message-id='${aiMessageId}']`);

        let scrolled = false;

        const highlightElement = (element) => {
            if (element) {
                // ‰ºòÂÖàÊªöÂä®Âà∞Áî®Êà∑Ê∂àÊÅØÔºåÂ¶ÇÊûúÁî®Êà∑Ê∂àÊÅØ‰∏çÂ≠òÂú®ÔºåÂàôÊªöÂä®Âà∞AIÊ∂àÊÅØ
                if (!scrolled) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    scrolled = true;
                }
                element.classList.add('highlight');
                setTimeout(() => {
                    element.classList.remove('highlight');
                }, 3000); // 3ÁßíÂêéÁßªÈô§È´ò‰∫ÆÊèêÁ§∫
            }
        };

        // È´ò‰∫ÆÁî®Êà∑ÂíåAIÊ∂àÊÅØ
        highlightElement(userElement);
        highlightElement(aiElement);

        if (scrolled) {
            message.success('Â∑≤Ë∑≥ËΩ¨Âà∞Áõ∏ÂÖ≥Ê∂àÊÅØ');
        } else {
            message.error('Êú™ËÉΩÂú®ÂΩìÂâç‰ºöËØù‰∏≠ÊâæÂà∞ËØ•Ê∂àÊÅØÔºåÂèØËÉΩÂ∑≤Ë¢´Âà†Èô§ÊàñÊõ¥Êñ∞„ÄÇ');
        }
    } catch (error) {
        message.error(`Ë∑≥ËΩ¨Â§±Ë¥•: ${error.message}`);
    }
};

// Ë∑≥ËΩ¨Âà∞ÈÖçÁΩÆÈ°µÈù¢
const goToConfig = () => {
    router.push('/config');
};

const logout = async () => {
    try {
        await userApi.logout();
        localStorage.removeItem('isLoggedIn');
        message.success('Â∑≤ÈÄÄÂá∫ÁôªÂΩï');
        router.push('/login');
    } catch (error) {
        message.error(`ÈîôËØØ:${error.message}`);
        return;
    }
};
</script>

<style scoped>
/* Ê†∑ÂºèÂ∑≤ÊèêÂèñÂà∞ assets/css/chat.css */
</style>